ARG TEXTSCOPE_BASE_IMAGE_VERSION

FROM docker.lomin.ai/ts-web-base:${TEXTSCOPE_BASE_IMAGE_VERSION}

ARG UBUNTU_VERSION
ARG POETRY_VERSION
ARG PYTHON_VERSION

ENV PATH="/root/.local/bin:${PATH}"
ENV PYTHONPATH="$PYTHONPATH:/workspace"

USER 0

COPY ./app /workspace/app
COPY ./assets/thales/ /workspace/assets/thales
COPY ./.env /workspace/.env
COPY ./requirements/web/pyproject.toml /workspace/
COPY ./requirements/web/poetry.lock /workspace/


WORKDIR /workspace
RUN sed -i 's/# Support for gcc and clang, restricting visibility as much as possible./env.Append(CCFLAGS=["-fcf-protection=none"])/' /usr/local/lib/python${PYTHON_VERSION}/dist-packages/nuitka/build/SconsCompilerSettings.py
RUN mv app/main.py ./main.py && \
    python3 -m nuitka --module app --include-package=app

RUN rm -rf /workspace/app /workspace/*.build /workspace/*.txt /workspace/Nuitka /workspace/assets && \
    rm -f /workspace/pyproject.toml /workspace/poetry.lock && \
    rm -rf /var/lib/apt/lists/*
